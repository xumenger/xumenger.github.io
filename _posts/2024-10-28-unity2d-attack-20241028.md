---
layout: post
title: Unity 横版2D 游戏开发学习笔记 - 4：实现攻击功能，并处理动画切换的问题
categories: 横版2D游戏开发
tags: 游戏 2D 横版 攻击 碰撞器 Tag 状态机 模板设计模式 
---

>参考[【Unity 2D游戏开发教程】](https://www.bilibili.com/video/BV1sE411L7kV)整理的学习笔记，对应github 的仓库地址为[https://github.com/zs8861/2D-Platform](https://github.com/zs8861/2D-Platform)

## 动画状态机

希望达成的效果是任何动画状态都可以在玩家按下【Shift】之后切换到攻击动画，所以可以从【Any State】切换到【Attack】

然后Attack 结束后，需要回到上一个状态，所以Attack 需要和Idle、Run、Jump 等分别有一个连线（考虑一下切换的条件分别是什么？）

动画状态机设计如下（但是因为Attack 结束后可以回到上次的状态，所以Attack 需要和所有的动画都有一个连线，很乱）：

![](../media/image/2024-10-28/01.png)

>攻击动作的播放已经在上文实现了！

## 攻击动画和功能

先说明一下需要实现的效果，角色Attack 时，当武器挥砍出去的时候，启动Polygon Collider 2D 碰撞器，进行碰撞检测，触发相关的攻击逻辑

Polygon Collider 2D 碰撞器需要包裹住攻击时的刀这个武器，用于后续和敌人判断是否碰撞使用

在Player 游戏物体下面新建一个PlayerAttack 子物体，为这个子物体增加Polygon Collider 2D 组件，这个Polygon Collider 2D 碰撞器放在这里进行管理，注意勾选IsTrigger 属性

切换到角色的动画到Attack，然后逐帧找到光刀完全挥出来的效果，也就是第4 帧

![](../media/image/2024-10-28/02.gif)

然后去调整Polygon Collider 2D 的范围，包裹住光刀

![](../media/image/2024-10-28/03.png)

## 攻击功能逻辑实现

在PlayerAttack 子物体上增加一个PlayerAttack.cs 脚本。注意把PlayerController.cs 里面关于攻击的动画逻辑迁移到这里

```c#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class PlayerAttack : MonoBehaviour
{
    public float damage = 2f;   // 伤害值

    private Animator animator;
    private PolygonCollider2D polygonCollider;

    // Start is called before the first frame update
    void Start()
    {
        animator = GameObject.FindGameObjectWithTag("Player").GetComponent<Animator>();

        // 获取碰撞体，开始是关闭的，等攻击的时候再打开
        polygonCollider = GetComponent<PolygonCollider2D>();
        polygonCollider.enabled = false;
    }

    // Update is called once per frame
    void Update()
    {
        // 按下【Shift】，进行攻击
        if (Input.GetKeyDown(KeyCode.LeftShift))
        {
            animator.SetBool("Attack", true);
            Debug.Log("Attack");  // 用于debug 分析

            // 通过协程控制，攻击动画播放一定时间后触发碰撞框
            StartCoroutine(StartAttackCoroutine());

            // 通过协程控制，一定时间后攻击结束
            StartCoroutine(StopAttackCoroutine());
        }
    }

    IEnumerator StartAttackCoroutine()
    {
        // 经过测试大概动画0.3s后，光刀挥出来
        yield return new WaitForSeconds(0.3f);  // 这里设置一个默认值，正常情况下应该是作为参数可配置的

        // 开启攻击碰撞框
        polygonCollider.enabled = true;
    }

    IEnumerator StopAttackCoroutine()
    {
        // 经过测试播放一次攻击动画大概0.5s
        yield return new WaitForSeconds(0.5f);   // 这里设置一个默认值，正常情况下应该是作为参数可配置的
        animator.SetBool("Attack", false);

        // 关闭攻击碰撞框
        polygonCollider.enabled = false;
    }
}

```

打开Gizmos，然后测试一下运行效果如下：

![](../media/image/2024-10-28/04.gif)

可以发现有一个问题：点击一次LeftShift，Attack 动画播放了三次，这个要怎么调整？

## 调试动画效果

除了上面出现的问题，还可能出现这种情况：按下LeftShift 后，进入到了攻击逻辑，但是没有按照预期播放Attack 动画

如下所示，中间有几次，以及最后一次只打开了PolygonCollider2D，但是没有播放Attack 动画

![](../media/image/2024-10-28/05.gif)

>所以调试动画的效果还是很繁琐的，需要对于细节、时间点、代码逻辑做好全面的分析和把控

## 设计一个敌人

在Aseprite 制作的一个蝙蝠怪，导入到Unity 之后，参考[《Unity 横版2D 游戏开发学习笔记 - 1：Unity 2D 动画基础》](https://xumenger.github.io/1-unity-2d-game-20241026/) 将其拆分，制作成动画，效果如下：

![](../media/image/2024-10-28/.gif)

## 攻击逻辑

攻击的逻辑是通过碰撞器实现的，逻辑阐述如下：

1. 如果玩家没有Attack 行为，蝙蝠的碰撞器碰到玩家的碰撞器，则玩家受伤
2. 如果玩家有Attack 行为，武器的碰撞器碰到蝙蝠的碰撞器，则蝙蝠受伤

综上，针对这个简单的攻击逻辑，涉及到三个碰撞器，以及它们之间的不同碰撞关系逻辑对应不同的业务逻辑

Enemy 上的脚本逻辑如下：

```c#

```

## 敌人抽象类

后续需要扩展不同的敌人，不同的敌人不同的攻击逻辑、属性值配置不同，所以可以基于模板设计模式抽象敌人的设计，设计一个抽象的Enemy 父类，后续不同的敌人都继承自它实现自己的个性化逻辑，有自己个性化的属性

```c#

```

现在只有一个蝙蝠敌人，可以直接继承它

```c#

```

## 遗留问题

1. 攻击时候的特效、音效、屏幕震动等还是缺失的，打击感不够
2. 有哪些增强打击感的技巧？
3. 现在的动画状态机连线看起来很乱、很复杂，应该如何优化？
4. Animator 中，Bool 变量和Trigger 变量各自的适用场景？
5. 现在的代码都是面向过程式的编程，至少对于动作部分怎么继续封装优化？
6. 武器的碰撞器在玩家按下【Shift】攻击时就变成enable，如果攻击有前摇呢，是否可以结果动画事件来控制enable 的时机？
7. 使用动画事件，游戏的可维护性是否不够好？是不是不够内聚
8. 攻击逻辑基于碰撞器和Tag 来实现，游戏工程越来越大，该如何规划和管理碰撞器、Tag？
9. 敌人的生命值、伤害值一般都是策划可设置的，比如不同类型的敌人配置的值是不同的
10. 设计多样、丰富的敌人有什么好的指导方法？
11. 如何设计游戏中的数值，保证整体的数值是平衡、有趣的？
12. 游戏中的Tag、Layer 越来越多，要系统化的管理起来
13. 随着游戏的复杂度增加，游戏各种物体的参数越来越多，这些如何有效管理起来？
